<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analizador Estad铆stico Melate Retro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      .stat-card {
        background-color: #1f2937;
        border: 1px solid #374151;
      }
      .hot-number {
        background-color: #dc2626;
        color: white;
      }
      .cold-number {
        background-color: #3b82f6;
        color: white;
      }
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .number-ball {
        width: 2.25rem;
        height: 2.25rem;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-weight: bold;
        box-shadow:
          inset 0 2px 4px rgba(0, 0, 0, 0.4),
          0 2px 3px rgba(0, 0, 0, 0.2);
      }
      .progress-bar {
        background-color: #374151;
        border-radius: 0.5rem;
        overflow: hidden;
      }
      .progress-bar-fill {
        height: 100%;
        background-color: #4f46e5;
        text-align: right;
        padding-right: 0.5rem;
        color: white;
        white-space: nowrap;
        transition: width 0.5s ease-in-out;
      }
      @media (min-width: 640px) {
        .number-ball {
          width: 2.5rem;
          height: 2.5rem;
          font-size: 1rem;
        }
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200">
    <div
      id="loading-overlay"
      class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex justify-center items-center z-50"
    >
      <div class="flex flex-col items-center">
        <i class="fas fa-spinner fa-spin fa-3x text-indigo-500"></i>
        <p id="loading-message" class="mt-4 text-lg">Cargando...</p>
      </div>
    </div>

    <!-- Contenedor de Login -->
    <div
      id="login-container"
      class="min-h-screen flex items-center justify-center p-4"
    >
      <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md">
        <h2 class="text-3xl font-bold text-center text-white mb-6">
          Iniciar Sesi贸n
        </h2>
        <p class="text-center text-gray-400 mb-6">
          Introduce tus credenciales para acceder al analizador.
        </p>
        <form id="login-form">
          <div class="mb-4">
            <label for="email" class="block text-gray-300 mb-2"
              >Correo Electr贸nico</label
            >
            <input
              type="email"
              id="email"
              class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
              required
            />
          </div>
          <div class="mb-6">
            <label for="password" class="block text-gray-300 mb-2"
              >Contrase帽a</label
            >
            <input
              type="password"
              id="password"
              class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
              required
            />
          </div>
          <button
            type="submit"
            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105"
          >
            Acceder
          </button>
        </form>
      </div>
    </div>

    <!-- Contenedor Principal de la App (Oculto por defecto) -->
    <div
      id="app-container"
      class="hidden container mx-auto p-4 md:p-8 max-w-7xl"
    >
      <header
        class="flex flex-col sm:flex-row justify-between items-center mb-8"
      >
        <div class="text-center sm:text-left mb-4 sm:mb-0">
          <h1
            class="text-3xl sm:text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500"
          >
            Analizador Estad铆stico
          </h1>
          <p class="text-gray-400 mt-2">
            Bienvenido. Explora patrones y genera sugerencias.
          </p>
          <div id="auth-status" class="mt-2 text-xs text-gray-500"></div>
        </div>
        <button
          id="btn-logout"
          class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg flex items-center"
        >
          <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesi贸n
        </button>
      </header>

      <main id="main-content">
        <!-- Tarjeta del ltimo Sorteo -->
        <div
          id="latest-draw-card"
          class="mb-8 p-6 bg-gray-800 rounded-lg shadow-xl border border-indigo-500/50"
        >
          <h2 class="text-2xl font-bold text-indigo-400 mb-4">
            ltimo Sorteo Registrado
          </h2>
          <div id="latest-draw-content">
            <!-- Contenido se llenar谩 con JS -->
          </div>
        </div>

        <!-- Controles Principales -->
        <div
          class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 xl:grid-cols-12 gap-3 mb-8"
        >
          <button
            data-view="stats-dashboard"
            class="view-btn col-span-1 bg-indigo-700 p-3 rounded-lg shadow-lg flex flex-col sm:flex-row items-center justify-center text-sm font-semibold transition-transform transform hover:scale-105"
          >
            <i class="fas fa-chart-pie sm:mr-2 mb-1 sm:mb-0"></i
            ><span class="text-center">Estad铆sticas</span>
          </button>
          <button
            data-view="diagnostics-view"
            class="view-btn col-span-1 bg-green-600 hover:bg-green-700 p-3 rounded-lg shadow-lg flex flex-col sm:flex-row items-center justify-center text-sm font-semibold transition-transform transform hover:scale-105"
          >
            <i class="fas fa-stethoscope sm:mr-2 mb-1 sm:mb-0"></i
            ><span class="text-center">Diagn贸stico</span>
          </button>
          <button
            data-view="predictions-view"
            class="view-btn col-span-1 bg-violet-600 hover:bg-violet-700 p-3 rounded-lg shadow-lg flex flex-col sm:flex-row items-center justify-center text-sm font-semibold transition-transform transform hover:scale-105"
          >
            <i class="fas fa-lightbulb sm:mr-2 mb-1 sm:mb-0"></i
            ><span class="text-center">Predicciones</span>
          </button>
          <button
            data-view="history-view"
            class="view-btn col-span-1 bg-blue-600 hover:bg-blue-700 p-3 rounded-lg shadow-lg flex flex-col sm:flex-row items-center justify-center text-sm font-semibold transition-transform transform hover:scale-105"
          >
            <i class="fas fa-history sm:mr-2 mb-1 sm:mb-0"></i
            ><span class="text-center">Hist贸rico</span>
          </button>
          <button
            data-view="generator-view"
            class="view-btn col-span-1 bg-purple-600 hover:bg-purple-700 p-3 rounded-lg shadow-lg flex flex-col sm:flex-row items-center justify-center text-sm font-semibold transition-transform transform hover:scale-105"
          >
            <i class="fas fa-magic-wand-sparkles sm:mr-2 mb-1 sm:mb-0"></i
            ><span class="text-center">Generador</span>
          </button>
          <button
            data-view="rater-view"
            class="view-btn col-span-1 bg-cyan-600 hover:bg-cyan-700 p-3 rounded-lg shadow-lg flex flex-col sm:flex-row items-center justify-center text-sm font-semibold transition-transform transform hover:scale-105"
          >
            <i class="fas fa-star-half-alt sm:mr-2 mb-1 sm:mb-0"></i
            ><span class="text-center">Calificar</span>
          </button>
          <button
            data-view="verifier-view"
            class="view-btn col-span-1 bg-teal-600 hover:bg-teal-700 p-3 rounded-lg shadow-lg flex flex-col sm:flex-row items-center justify-center text-sm font-semibold transition-transform transform hover:scale-105"
          >
            <i class="fas fa-tasks sm:mr-2 mb-1 sm:mb-0"></i
            ><span class="text-center">Verificador</span>
          </button>
          <button
            data-view="reviewer-view"
            class="view-btn col-span-1 bg-pink-600 hover:bg-pink-700 p-3 rounded-lg shadow-lg flex flex-col sm:flex-row items-center justify-center text-sm font-semibold transition-transform transform hover:scale-105"
          >
            <i class="fas fa-search-plus sm:mr-2 mb-1 sm:mb-0"></i
            ><span class="text-center">Revisar</span>
          </button>
          <button
            data-view="top-global-view"
            class="view-btn col-span-1 bg-yellow-500 hover:bg-yellow-600 text-gray-900 p-3 rounded-lg shadow-lg flex flex-col sm:flex-row items-center justify-center text-sm font-semibold transition-transform transform hover:scale-105"
          >
            <i class="fas fa-trophy sm:mr-2 mb-1 sm:mb-0"></i
            ><span class="text-center">Top Global</span>
          </button>
          <button
            id="btn-adjust-strategy"
            class="view-btn col-span-1 bg-amber-600 hover:bg-amber-700 p-3 rounded-lg shadow-lg flex flex-col sm:flex-row items-center justify-center text-sm font-semibold transition-transform transform hover:scale-105"
          >
            <i class="fas fa-brain sm:mr-2 mb-1 sm:mb-0"></i
            ><span class="text-center">Mejorar</span>
          </button>
          <button
            id="btn-recalculate-weights"
            class="view-btn col-span-1 bg-rose-600 hover:bg-rose-700 p-3 rounded-lg shadow-lg flex flex-col sm:flex-row items-center justify-center text-sm font-semibold transition-transform transform hover:scale-105"
          >
            <i class="fas fa-calculator sm:mr-2 mb-1 sm:mb-0"></i
            ><span class="text-center">Calcular Pesos</span>
          </button>
          <button
            id="btn-upload-csv"
            class="view-btn col-span-1 bg-green-700 hover:bg-green-800 p-3 rounded-lg shadow-lg flex flex-col sm:flex-row items-center justify-center text-sm font-semibold transition-transform transform hover:scale-105"
          >
            <i class="fas fa-upload sm:mr-2 mb-1 sm:mb-0"></i
            ><span class="text-center">Cargar CSV</span>
          </button>
        </div>

        <!-- Contenedor de Vistas -->
        <div id="view-container">
          <div id="stats-dashboard" class="main-view hidden">
            <h2 class="text-3xl font-bold mb-6 border-b-2 border-gray-700 pb-2">
              Dashboard de Estad铆sticas
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <div class="stat-card p-4 rounded-lg">
                <h3 class="text-xl font-semibold mb-3">
                  <i class="fas fa-fire mr-2 text-red-500"></i>Frecuencia
                </h3>
                <div class="flex flex-col sm:flex-row sm:justify-between gap-4">
                  <div>
                    <h4 class="font-bold text-red-400"> Calientes</h4>
                    <div
                      id="hot-numbers"
                      class="flex flex-wrap gap-2 mt-2"
                    ></div>
                  </div>
                  <div>
                    <h4 class="font-bold text-blue-400">锔 Fr铆os</h4>
                    <div
                      id="cold-numbers"
                      class="flex flex-wrap gap-2 mt-2"
                    ></div>
                  </div>
                </div>
              </div>
              <div class="stat-card p-4 rounded-lg">
                <h3 class="text-xl font-semibold mb-3">
                  <i class="fas fa-hourglass-half mr-2 text-yellow-500"></i
                  >Atraso de N煤meros
                </h3>
                <div id="atraso-numbers"></div>
              </div>
              <div class="stat-card p-4 rounded-lg">
                <h3 class="text-xl font-semibold mb-3">
                  <i class="fas fa-link mr-2 text-green-500"></i>Pares M谩s
                  Frecuentes
                </h3>
                <div id="top-pairs"></div>
              </div>
              <div class="stat-card p-4 rounded-lg">
                <h3 class="text-xl font-semibold mb-3">
                  <i class="fas fa-calculator mr-2 text-cyan-500"></i>An谩lisis
                  de Sumas
                </h3>
                <div id="sum-analysis"></div>
              </div>
              <div class="stat-card p-4 rounded-lg">
                <h3 class="text-xl font-semibold mb-3">
                  <i class="fas fa-divide mr-2 text-pink-500"></i>Pares e
                  Impares
                </h3>
                <div id="odd-even-analysis"></div>
              </div>
              <div class="stat-card p-4 rounded-lg">
                <h3 class="text-xl font-semibold mb-3">
                  <i class="fas fa-layer-group mr-2 text-purple-500"></i
                  >Distribuci贸n de Decenas
                </h3>
                <div id="tens-analysis"></div>
              </div>
              <div class="stat-card p-4 rounded-lg lg:col-span-3">
                <h3 class="text-xl font-semibold mb-3">
                  <i class="fas fa-balance-scale mr-2 text-orange-500"></i>Pesos
                  de Estrategia Inteligente
                </h3>
                <div
                  id="strategy-weights"
                  class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-9 gap-4"
                ></div>
              </div>
            </div>
          </div>

          <div id="diagnostics-view" class="main-view hidden">
            <!-- El contenido se genera din谩micamente -->
          </div>

          <div id="predictions-view" class="main-view hidden"></div>
          <div id="history-view" class="main-view hidden"></div>
          <div id="generator-view" class="main-view hidden"></div>
          <div id="rater-view" class="main-view hidden"></div>
          <div id="verifier-view" class="main-view hidden"></div>
          <div id="reviewer-view" class="main-view hidden"></div>
          <div id="top-global-view" class="main-view hidden"></div>
        </div>

        <div
          id="upload-container"
          class="hidden text-center mt-16 p-8 bg-gray-800 rounded-lg border-2 border-dashed border-gray-600"
        >
          <i class="fas fa-database fa-3x text-gray-500 mb-4"></i>
          <h2 class="text-2xl font-bold mb-2">Base de Datos Vac铆a</h2>
          <p class="text-gray-400 mb-6">
            Para comenzar, por favor carga el archivo CSV con los resultados
            hist贸ricos.
          </p>
          <button
            id="btn-trigger-upload"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105"
          >
            <i class="fas fa-upload mr-2"></i>Seleccionar archivo CSV
          </button>
          <input type="file" id="csv-file-input" class="hidden" accept=".csv" />
        </div>
      </main>
    </div>

    <!-- Modal para notificaciones -->
    <div id="notification-modal" class="hidden modal-backdrop">
      <div
        class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-sm w-full text-center"
      >
        <p id="notification-message" class="text-lg whitespace-pre-wrap"></p>
        <button
          id="btn-close-notification"
          class="mt-6 bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg font-semibold"
        >
          Cerrar
        </button>
      </div>
    </div>

    <!-- Modal para Confirmaci贸n -->
    <div id="confirmation-modal" class="hidden modal-backdrop">
      <div
        class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-sm w-full text-center"
      >
        <h3 class="text-xl font-bold text-yellow-400 mb-4">
          Confirmaci贸n Requerida
        </h3>
        <p id="confirmation-message" class="text-lg"></p>
        <div class="mt-6 flex justify-around">
          <button
            id="btn-confirm-action"
            class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold"
          >
            Confirmar
          </button>
          <button
            id="btn-cancel-action"
            class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
        setDoc,
        query,
        orderBy,
        writeBatch,
        where,
        limit,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD1aCSuPzCawECNebHLLBXvj9qYr3QVjT4",
        authDomain: "analizadormelateretro.firebaseapp.com",
        projectId: "analizadormelateretro",
        storageBucket: "analizadormelateretro.firebasestorage.app",
        messagingSenderId: "852396148354",
        appId: "1:852396148354:web:fc430c9d8ffdb19ce1d69b",
        measurementId: "G-E0Z2VFNLT2",
      };
      const appId = firebaseConfig.appId;

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const resultsCollectionRef = collection(
        db,
        `artifacts/${appId}/public/data/results`,
      );
      const bruteForceResultsCollectionRef = collection(
        db,
        `artifacts/${appId}/public/data/bruteForceSuggestions`,
      );
      const configDocRef = doc(
        db,
        `artifacts/${appId}/public/data/config/strategyWeights`,
      );
      const lastAnalyzedDocRef = doc(
        db,
        `artifacts/${appId}/public/data/config/lastAnalyzedDraw`,
      );
      const suggestionsCollectionRef = collection(
        db,
        `artifacts/${appId}/public/data/suggestions`,
      );

      // --- GLOBAL VARIABLES ---
      let lastDraw = null;
      let analysis = {};
      let strategyWeights = {};
      let lastAnalyzedDrawNumber = 0;
      let fullHistory = [];

      const defaultWeights = {
        suma_rango: 15,
        dist_par_impar: 15,
        mix_frecuencia: 10,
        mix_atraso: 10,
        decenas_distribucion: 10,
        pares_frecuentes: 10,
        prediccion_markov: 15,
        consecutivos: 10,
        terminaciones: 5,
      };

      // --- APP INITIALIZATION ---
      window.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("login-form")
          ?.addEventListener("submit", handleLogin);
        onAuthStateChanged(auth, (user) => {
          if (user) {
            document.getElementById("login-container")?.classList.add("hidden");
            document
              .getElementById("app-container")
              ?.classList.remove("hidden");
            document.getElementById("auth-status").textContent =
              `Usuario: ${user.email}`;
            loadInitialData();
          } else {
            document
              .getElementById("login-container")
              ?.classList.remove("hidden");
            document.getElementById("app-container")?.classList.add("hidden");
          }
        });
        document
          .getElementById("btn-logout")
          ?.addEventListener("click", () => signOut(auth));
        document
          .getElementById("btn-close-notification")
          ?.addEventListener("click", () => {
            document
              .getElementById("notification-modal")
              ?.classList.add("hidden");
          });
      });

      async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const loadingOverlay = document.getElementById("loading-overlay");
        loadingOverlay.classList.remove("hidden");
        loadingOverlay.querySelector("#loading-message").textContent =
          "Autenticando...";
        try {
          await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
          showNotification(`Error de inicio de sesi贸n: ${error.code}`);
        } finally {
          loadingOverlay.classList.add("hidden");
        }
      }

      // --- DATA LOADING (OPTIMIZED) ---
      async function loadInitialData() {
        const loadingOverlay = document.getElementById("loading-overlay");
        try {
          loadingOverlay.classList.remove("hidden");
          loadingOverlay.querySelector("#loading-message").textContent =
            "Cargando an谩lisis...";

          const analysisDocRef = doc(
            db,
            `artifacts/${appId}/public/data/analysis/latest`,
          );
          const lastDrawQuery = query(
            resultsCollectionRef,
            orderBy("sorteo", "desc"),
            limit(1),
          );

          const [analysisDoc, weightsDoc, lastAnalyzedDoc, lastDrawSnapshot] =
            await Promise.all([
              getDoc(analysisDocRef),
              getDoc(configDocRef),
              getDoc(lastAnalyzedDocRef),
              getDocs(lastDrawQuery),
            ]);

          if (!analysisDoc.exists()) {
            showNotification(
              "A煤n no se ha generado el an谩lisis. Ejecuta el script de pre-c贸mputo.",
            );
            document
              .getElementById("upload-container")
              ?.classList.remove("hidden");
            return;
          }

          analysis = analysisDoc.data();

          if (
            analysis.topEndings_list &&
            Array.isArray(analysis.topEndings_list)
          ) {
            analysis.topEndings = new Set(analysis.topEndings_list);
          }
          if (
            analysis.topPairsSet_list &&
            Array.isArray(analysis.topPairsSet_list)
          ) {
            analysis.topPairsSet = new Set(analysis.topPairsSet_list);
          }

          if (weightsDoc.exists()) {
            strategyWeights = { ...defaultWeights, ...weightsDoc.data() };
          } else {
            strategyWeights = defaultWeights;
          }

          if (lastAnalyzedDoc.exists()) {
            lastAnalyzedDrawNumber = lastAnalyzedDoc.data().sorteo;
          }

          if (!lastDrawSnapshot.empty) {
            lastDraw = lastDrawSnapshot.docs[0].data();
          }

          setupUI();
          displayLatestResult();
          document.getElementById("main-content").classList.remove("hidden");
          document.getElementById("upload-container")?.classList.add("hidden");
          switchView("stats-dashboard");
        } catch (error) {
          console.error("Error al cargar datos iniciales:", error);
          showNotification("Error al cargar los datos iniciales.");
        } finally {
          loadingOverlay.classList.add("hidden");
        }
      }

      async function loadFullHistory() {
        if (fullHistory.length > 0) return true;
        const loadingOverlay = document.getElementById("loading-overlay");
        loadingOverlay.classList.remove("hidden");
        loadingOverlay.querySelector("#loading-message").textContent =
          "Cargando hist贸rico...";
        try {
          const resultsSnapshot = await getDocs(
            query(resultsCollectionRef, orderBy("sorteo", "desc")),
          );
          fullHistory = resultsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));
          return true;
        } catch (error) {
          showNotification("Error al cargar el hist贸rico completo.");
          return false;
        } finally {
          loadingOverlay.classList.add("hidden");
        }
      }

      // --- VIEW SWITCHING ---
      function switchView(viewId) {
        document
          .querySelectorAll(".main-view")
          .forEach((view) => view.classList.add("hidden"));
        const viewToShow = document.getElementById(viewId);
        if (viewToShow) {
          viewToShow.classList.remove("hidden");
          const requiresHistory = [
            "diagnostics-view",
            "history-view",
            "generator-view",
            "verifier-view",
            "reviewer-view",
            "predictions-view",
          ];

          const display = async () => {
            if (requiresHistory.includes(viewId)) {
              const historyLoaded = await loadFullHistory();
              if (!historyLoaded) return;
            }
            switch (viewId) {
              case "stats-dashboard":
                displayStats();
                break;
              case "diagnostics-view":
                displayDiagnosticsDashboard();
                break;
              case "history-view":
                displayHistory();
                break;
              case "predictions-view":
                displayPredictions();
                break;
              case "generator-view":
                displayGenerator();
                break;
              case "rater-view":
                displayRater();
                break;
              case "verifier-view":
                displayVerifier();
                break;
              case "reviewer-view":
                displayReviewer();
                break;
              case "top-global-view":
                displayTopGlobal();
                break;
            }
          };
          display();
        }
      }

      // --- ALL OTHER FUNCTIONS RESTORED ---

      // --- SETUP ---
      function setupUI() {
        document.querySelectorAll(".view-btn").forEach((button) => {
          button.addEventListener("click", () => {
            const viewId = button.dataset.view;
            document
              .querySelectorAll(".view-btn")
              .forEach((btn) =>
                btn.classList.remove("bg-indigo-700", "bg-green-700"),
              );

            document.querySelectorAll(".view-btn").forEach((btn) => {
              btn.classList.remove("bg-indigo-700", "bg-green-700");
              const originalColor =
                btn.dataset.originalColor || "bg-indigo-600";
              btn.classList.add(originalColor);
            });

            button.classList.remove(
              button.dataset.originalColor || "bg-indigo-600",
            );
            button.classList.add(
              viewId === "diagnostics-view" ? "bg-green-700" : "bg-indigo-700",
            );

            switchView(viewId);
          });
        });

        document.querySelectorAll(".view-btn").forEach((btn) => {
          const colorClass = Array.from(btn.classList).find((c) =>
            c.startsWith("bg-"),
          );
          btn.dataset.originalColor = colorClass;
        });

        document
          .getElementById("btn-adjust-strategy")
          ?.addEventListener("click", adjustStrategy);
        document
          .getElementById("btn-recalculate-weights")
          ?.addEventListener("click", showRecalculateConfirmation);
        setupUploadListeners();
      }

      function displayHistory() {
        const container = document.getElementById("history-view");
        container.innerHTML =
          `<h2 class="text-3xl font-bold mb-6 border-b-2 border-gray-700 pb-2">Hist贸rico de Resultados</h2><div class="overflow-x-auto stat-card rounded-lg"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-300 uppercase bg-gray-700"><tr><th scope="col" class="px-6 py-3">Sorteo</th><th scope="col" class="px-6 py-3">Fecha</th><th scope="col" class="px-6 py-3">Combinaci贸n Ganadora</th></tr></thead><tbody>` +
          fullHistory
            .map(
              (draw) =>
                `<tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700/50"><td class="px-6 py-4 font-medium">${
                  draw.sorteo
                }</td><td class="px-6 py-4">${
                  draw.FECHA
                }</td><td class="px-6 py-4 font-mono">${[
                  draw.F1,
                  draw.F2,
                  draw.F3,
                  draw.F4,
                  draw.F5,
                  draw.F6,
                ].join(", ")}</td></tr>`,
            )
            .join("") +
          `</tbody></table></div>`;
      }

      function displayLatestResult() {
        if (!lastDraw) {
          document.getElementById("latest-draw-card").classList.add("hidden");
          return;
        }
        document.getElementById("latest-draw-card").classList.remove("hidden");
        const numbers = [
          lastDraw.F1,
          lastDraw.F2,
          lastDraw.F3,
          lastDraw.F4,
          lastDraw.F5,
          lastDraw.F6,
        ];
        document.getElementById("latest-draw-content").innerHTML =
          ` <div class="flex flex-col md:flex-row justify-between items-center"> <div><p class="text-gray-400">Sorteo No. <span class="font-bold text-white">${
            lastDraw.sorteo
          }</span></p><p class="text-gray-400">Fecha: <span class="font-bold text-white">${
            lastDraw.FECHA
          }</span></p></div> <div class="flex flex-wrap justify-center gap-2 mt-4 md:mt-0">${numbers
            .map(
              (n) =>
                `<span class="number-ball bg-gray-700 text-gray-100">${n}</span>`,
            )
            .join("")}</div> </div>`;
      }

      function displayStats() {
        if (!analysis || !analysis.frequencies) return;
        const container = document.getElementById("stats-dashboard");
        if (!container) return;

        container.querySelector("#hot-numbers").innerHTML = analysis.frequencies
          .slice(0, 5)
          .map(
            (item) =>
              `<span class="hot-number font-bold w-10 h-10 flex items-center justify-center rounded-full">${item.number}</span>`,
          )
          .join("");
        container.querySelector("#cold-numbers").innerHTML =
          analysis.frequencies
            .slice(-5)
            .map(
              (item) =>
                `<span class="cold-number font-bold w-10 h-10 flex items-center justify-center rounded-full">${item.number}</span>`,
            )
            .join("");
        container.querySelector("#atraso-numbers").innerHTML = analysis.lags
          .slice(0, 5)
          .map(
            (item) =>
              `<div class="flex justify-between items-center text-sm mb-1"><span>N煤mero <b>${item.number}</b>:</span> <span class="font-semibold">${item.lag} sorteos</span></div>`,
          )
          .join("");
        container.querySelector("#top-pairs").innerHTML = analysis.topPairs
          .slice(0, 5)
          .map(
            (item) =>
              `<div class="flex justify-between items-center text-sm mb-1"><span>Par <b>${item.pair.join(
                ", ",
              )}</b>:</span> <span class="font-semibold">${
                item.count
              } veces</span></div>`,
          )
          .join("");
        container.querySelector("#sum-analysis").innerHTML =
          `<p class="text-sm">Suma Promedio: <b>${analysis.sumAnalysis.mean.toFixed(
            2,
          )}</b></p><p class="text-sm">Rango Frecuente (25%-75%): <b>${analysis.sumAnalysis.q25.toFixed(
            0,
          )} - ${analysis.sumAnalysis.q75.toFixed(0)}</b></p>`;
        container.querySelector("#odd-even-analysis").innerHTML =
          analysis.oddEvenDistribution
            .slice(0, 3)
            .map(
              (item) =>
                `<div class="flex justify-between items-center text-sm mb-1"><span><b>${item.dist}</b>:</span> <span class="font-semibold">${item.count} veces</span></div>`,
            )
            .join("");
        container.querySelector("#tens-analysis").innerHTML =
          analysis.tensDistribution
            .slice(0, 3)
            .map(
              (item) =>
                `<div class="flex justify-between items-center text-sm mb-1"><span><b>${item.dist}</b>:</span> <span class="font-semibold">${item.count} veces</span></div>`,
            )
            .join("");
        displayStrategyWeights();
      }

      function setupUploadListeners() {
        const uploadButton = document.getElementById("btn-trigger-upload");
        const fileInput = document.getElementById("csv-file-input");
        if (uploadButton)
          uploadButton.addEventListener("click", () => fileInput.click());
        if (fileInput) fileInput.addEventListener("change", handleFileUpload);
        const menuUploadButton = document.getElementById("btn-upload-csv");
        if (menuUploadButton)
          menuUploadButton.addEventListener("click", () => fileInput.click());
      }

      function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          const text = e.target.result;
          parseAndUploadCSV(text);
        };
        reader.readAsText(file);
      }

      async function parseAndUploadCSV(csvText) {
        document.getElementById("loading-overlay").classList.remove("hidden");
        document.getElementById("loading-message").textContent =
          "Procesando y subiendo CSV...";
        const lines = csvText.trim().split("\n");
        const header = lines[0].split(",").map((h) => h.trim());
        const requiredHeaders = [
          "CONCURSO",
          "FECHA",
          "F1",
          "F2",
          "F3",
          "F4",
          "F5",
          "F6",
        ];
        if (!requiredHeaders.every((h) => header.includes(h))) {
          showNotification(
            `El archivo CSV no es v谩lido. Columnas requeridas: ${requiredHeaders.join(", ")}`,
          );
          document.getElementById("loading-overlay").classList.add("hidden");
          return;
        }
        const records = lines.slice(1).map((line) => {
          const values = line.split(",");
          const record = header.reduce((obj, h, i) => {
            obj[h] = values[i] ? values[i].trim() : "";
            return obj;
          }, {});
          return record;
        });
        try {
          const batch = writeBatch(db);
          records.forEach((record) => {
            const sorteoNum = parseInt(record.CONCURSO, 10);
            if (isNaN(sorteoNum)) return;
            const newDocRef = doc(resultsCollectionRef, String(sorteoNum));
            batch.set(newDocRef, {
              sorteo: sorteoNum,
              FECHA: record.FECHA,
              F1: parseInt(record.F1, 10),
              F2: parseInt(record.F2, 10),
              F3: parseInt(record.F3, 10),
              F4: parseInt(record.F4, 10),
              F5: parseInt(record.F5, 10),
              F6: parseInt(record.F6, 10),
            });
          });
          await batch.commit();
          showNotification(
            `隆xito! Se cargaron ${records.length} registros. La aplicaci贸n se recargar谩.`,
          );
          setTimeout(() => window.location.reload(), 2000);
        } catch (error) {
          console.error("Error al subir el lote a Firestore:", error);
          showNotification(
            "Ocurri贸 un error al subir los datos. Revisa la consola.",
          );
          document.getElementById("loading-overlay").classList.add("hidden");
        }
      }

      function rateCombination(comboArr) {
        let score = 0;
        const maxScore =
          Object.values(strategyWeights).reduce((a, b) => a + b, 0) || 100;
        let breakdown = {};
        const freqs = analysis.frequencies;
        const cold = new Set(freqs.slice(-13).map((f) => f.number));
        const hot = new Set(freqs.slice(0, 13).map((f) => f.number));

        let sumaScore = 0;
        const comboSum = comboArr.reduce((a, b) => a + b, 0);
        const mean = analysis.sumAnalysis.mean;
        const std = analysis.sumAnalysis.std;
        if (Math.abs(comboSum - mean) < 0.75 * std) {
          sumaScore = strategyWeights.suma_rango;
        } else if (Math.abs(comboSum - mean) < 1.5 * std) {
          sumaScore = strategyWeights.suma_rango / 2;
        }
        score += sumaScore;
        breakdown["Suma en Rango"] = sumaScore;

        let parImparScore = 0;
        const evens = comboArr.filter((n) => n % 2 === 0).length;
        const distStr = `${evens}P-${6 - evens}I`;
        const topOddEven = analysis.oddEvenDistribution
          .slice(0, 3)
          .map((d) => d.dist);
        const distIndex = topOddEven.indexOf(distStr);
        if (distIndex === 0) {
          parImparScore = strategyWeights.dist_par_impar;
        } else if (distIndex > 0) {
          parImparScore = strategyWeights.dist_par_impar * 0.5;
        }
        score += parImparScore;
        breakdown["Distribuci贸n Par/Impar"] = parImparScore;

        let mixFrecuenciaScore = 0;
        const coldCount = comboArr.filter((n) => cold.has(n)).length;
        const hotCount = comboArr.filter((n) => hot.has(n)).length;
        const mediumCount = 6 - coldCount - hotCount;
        const frecBalanceScore =
          1 -
          (Math.abs(coldCount - 2) +
            Math.abs(hotCount - 2) +
            Math.abs(mediumCount - 2)) /
            8;
        mixFrecuenciaScore = frecBalanceScore * strategyWeights.mix_frecuencia;
        score += mixFrecuenciaScore;
        breakdown["Mix Frecuencia"] = mixFrecuenciaScore;

        let lagMixScore = 0;
        const highLagCount = comboArr.filter((n) =>
          new Set(analysis.lags.slice(0, 13).map((l) => l.number)).has(n),
        ).length;
        const lowLagCount = comboArr.filter((n) =>
          new Set(analysis.lags.slice(-13).map((l) => l.number)).has(n),
        ).length;
        const mediumLagCount = 6 - highLagCount - lowLagCount;
        const lagBalanceScore =
          1 -
          (Math.abs(highLagCount - 2) +
            Math.abs(mediumLagCount - 2) +
            Math.abs(lowLagCount - 2)) /
            8;
        lagMixScore = lagBalanceScore * strategyWeights.mix_atraso;
        score += lagMixScore;
        breakdown["Mix Atraso"] = lagMixScore;

        let tensScore = 0;
        const tens = [0, 0, 0, 0];
        comboArr.forEach((n) => {
          if (n <= 9) tens[0]++;
          else if (n <= 19) tens[1]++;
          else if (n <= 29) tens[2]++;
          else tens[3]++;
        });
        const tensDistStr = tens.sort((a, b) => b - a).join("-");
        const topTens = analysis.tensDistribution
          .slice(0, 3)
          .map((d) => d.dist);
        const tensIndex = topTens.indexOf(tensDistStr);
        if (tensIndex === 0) {
          tensScore = strategyWeights.decenas_distribucion;
        } else if (tensIndex > 0) {
          tensScore = strategyWeights.decenas_distribucion * 0.5;
        }
        score += tensScore;
        breakdown["Distribuci贸n Decenas"] = tensScore;

        let pairScore = 0;
        let pairHits = 0;
        for (const pair of combinations(comboArr, 2)) {
          if (
            analysis.topPairsSet &&
            analysis.topPairsSet.has(JSON.stringify(pair.sort((a, b) => a - b)))
          )
            pairHits++;
        }
        pairScore = (pairHits / 6) * strategyWeights.pares_frecuentes;
        score += pairScore;
        breakdown["Pares Frecuentes"] = pairScore;

        let markovScore = 0;
        if (lastDraw) {
          const lastDrawNumbers = [
            lastDraw.F1,
            lastDraw.F2,
            lastDraw.F3,
            lastDraw.F4,
            lastDraw.F5,
            lastDraw.F6,
          ];
          let predictedHits = 0;
          for (const prevNum of lastDrawNumbers) {
            if (analysis.markovTransitions[prevNum]) {
              const topTransitions = Object.entries(
                analysis.markovTransitions[prevNum],
              )
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5)
                .map(([num]) => parseInt(num));
              predictedHits += comboArr.filter((n) =>
                topTransitions.includes(n),
              ).length;
            }
          }
          markovScore =
            (predictedHits / (6 * 5)) * strategyWeights.prediccion_markov;
        }
        score += markovScore;
        breakdown["Predicci贸n Markov"] = markovScore;

        let consecutiveScore = 0;
        const sortedCombo = [...comboArr].sort((a, b) => a - b);
        let consecutivePairs = 0;
        for (let i = 0; i < sortedCombo.length - 1; i++) {
          if (sortedCombo[i + 1] - sortedCombo[i] === 1) consecutivePairs++;
        }
        const topConsecutivePatterns = analysis.consecutiveDistribution
          .slice(0, 2)
          .map((d) => d.pairs);
        if (topConsecutivePatterns.includes(consecutivePairs)) {
          consecutiveScore = strategyWeights.consecutivos;
        }
        score += consecutiveScore;
        breakdown["Consecutivos"] = consecutiveScore;

        let endingScore = 0;
        const comboEndings = comboArr.map((n) => n % 10);
        const endingHits = comboEndings.filter(
          (ending) => analysis.topEndings && analysis.topEndings.has(ending),
        ).length;
        endingScore = (endingHits / 6) * strategyWeights.terminaciones;
        score += endingScore;
        breakdown["Terminaciones"] = endingScore;

        const confidence = (score / maxScore) * 100;
        return { confidence, breakdown };
      }

      async function adjustStrategy() {
        if (fullHistory.length < 2) {
          showNotification(
            "Carga el hist贸rico completo primero desde la pesta帽a 'Hist贸rico'.",
          );
          return;
        }
        const lastDrawInDb = fullHistory[0];
        if (lastDrawInDb.sorteo <= lastAnalyzedDrawNumber) {
          showNotification(
            `La estrategia ya fue ajustada con el sorteo ${lastDrawInDb.sorteo}. Espera un nuevo resultado.`,
          );
          return;
        }
        const winningCombo = [
          lastDrawInDb.F1,
          lastDrawInDb.F2,
          lastDrawInDb.F3,
          lastDrawInDb.F4,
          lastDrawInDb.F5,
          lastDrawInDb.F6,
        ].sort((a, b) => a - b);
        showNotification(
          `Analizando sorteo ${lastDrawInDb.sorteo} para mejorar estrategia...`,
        );
        const increaseFactor = 1.01,
          decreaseFactor = 0.99,
          decayRate = 0.05;
        let changes = [];
        const { breakdown } = rateCombination(winningCombo);
        const ruleToWeightMap = {
          "Suma en Rango": "suma_rango",
          "Distribuci贸n Par/Impar": "dist_par_impar",
          "Mix Frecuencia": "mix_frecuencia",
          "Pares Frecuentes": "pares_frecuentes",
          "Mix Atraso": "mix_atraso",
          "Distribuci贸n Decenas": "decenas_distribucion",
          "Predicci贸n Markov": "prediccion_markov",
          Consecutivos: "consecutivos",
          Terminaciones: "terminaciones",
        };
        Object.entries(breakdown).forEach(([ruleKey, ruleScore]) => {
          const weightKey = ruleToWeightMap[ruleKey];
          if (strategyWeights[weightKey] && ruleScore !== undefined) {
            if (ruleScore > 0) {
              strategyWeights[weightKey] *= increaseFactor;
              changes.push(`${ruleKey}: Peso aumentado.`);
            } else {
              strategyWeights[weightKey] *= decreaseFactor;
              changes.push(`${ruleKey}: Peso reducido.`);
            }
          }
        });
        Object.keys(strategyWeights).forEach((key) => {
          strategyWeights[key] =
            strategyWeights[key] * (1 - decayRate) +
            defaultWeights[key] * decayRate;
        });
        changes.push("Regularizaci贸n aplicada para mantener balance.");
        try {
          await setDoc(configDocRef, strategyWeights);
          await setDoc(lastAnalyzedDocRef, { sorteo: lastDrawInDb.sorteo });
          lastAnalyzedDrawNumber = lastDrawInDb.sorteo;
          showNotification("隆Estrategia mejorada!\n" + changes.join("\n"));
          displayStrategyWeights();
        } catch (e) {
          console.error("Error al guardar la mejora: ", e);
          showNotification("Error al guardar la mejora de la estrategia.");
        }
      }

      function generateIntelligentCombinations(
        quantity,
        minConfidence,
        numBalls,
      ) {
        if (numBalls > 6) {
          const powerRanking = calculatePowerRanking();
          const topNumbers = powerRanking
            .slice(0, numBalls)
            .map((item) => item.number);
          return [
            {
              combination: topNumbers.sort((a, b) => a - b),
              confidence: `Grupo de ${numBalls} con Mayor Potencial`,
            },
          ];
        }
        const candidates = {};
        const maxAttempts = 50000;
        for (let i = 0; i < maxAttempts; i++) {
          const combo = new Set();
          while (combo.size < 6) combo.add(Math.floor(Math.random() * 39) + 1);
          const comboArr = Array.from(combo).sort((a, b) => a - b);
          const comboKey = JSON.stringify(comboArr);
          if (candidates[comboKey]) continue;
          const { confidence } = rateCombination(comboArr);
          candidates[comboKey] = confidence;
        }
        const sortedCandidates = Object.entries(candidates)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 100);
        const filtered = sortedCandidates
          .filter(([, conf]) => conf >= minConfidence)
          .slice(0, quantity);
        if (sortedCandidates.length > 0 && filtered.length < quantity) {
          showNotification(
            `No se encontraron suficientes combinaciones. Se muestran las mejores ${sortedCandidates.slice(0, quantity).length} encontradas.`,
          );
          return sortedCandidates
            .slice(0, quantity)
            .map(([comboStr, confidence]) => ({
              combination: JSON.parse(comboStr),
              confidence: `Confianza: ${confidence.toFixed(0)}%`,
            }));
        }
        return filtered.map(([comboStr, confidence]) => ({
          combination: JSON.parse(comboStr),
          confidence: `Confianza: ${confidence.toFixed(0)}%`,
        }));
      }

      function generateSimpleCombinations(quantity, strategy) {
        const combinationsSet = new Set();
        let attempts = 0;
        const maxAttempts = quantity * 100;
        const hotNumbers = analysis.frequencies
          .slice(0, 12)
          .map((f) => f.number);
        const coldNumbers = analysis.frequencies
          .slice(-12)
          .map((f) => f.number);
        const evenNumbers = Array.from({ length: 19 }, (_, i) => (i + 1) * 2);
        const oddNumbers = Array.from({ length: 20 }, (_, i) => i * 2 + 1);
        const sumMin = analysis.sumAnalysis.q25;
        const sumMax = analysis.sumAnalysis.q75;
        while (combinationsSet.size < quantity && attempts < maxAttempts) {
          let combo = [];
          if (strategy === "calientes")
            combo = Array.from(sample(hotNumbers, 6));
          else if (strategy === "frios")
            combo = Array.from(sample(coldNumbers, 6));
          else if (strategy === "aleatorio")
            combo = Array.from(
              sample(
                Array.from({ length: 39 }, (_, i) => i + 1),
                6,
              ),
            );
          else if (strategy === "3_pares_3_impares")
            combo = [...sample(evenNumbers, 3), ...sample(oddNumbers, 3)];
          else if (strategy === "suma_frecuente") {
            let tempCombo = Array.from(
              sample(
                Array.from({ length: 39 }, (_, i) => i + 1),
                6,
              ),
            );
            let tempSum = tempCombo.reduce((a, b) => a + b, 0);
            if (tempSum >= sumMin && tempSum <= sumMax) combo = tempCombo;
          }
          if (combo.length === 6) {
            combinationsSet.add(JSON.stringify(combo.sort((a, b) => a - b)));
          }
          attempts++;
        }
        return Array.from(combinationsSet).map((c) => ({
          combination: JSON.parse(c),
          confidence: "(Estrategia Simple)",
        }));
      }

      function calculatePowerRanking() {
        const scores = Array.from({ length: 39 }, (_, i) => ({
          number: i + 1,
          score: 0,
        }));
        const maxFreq = analysis.frequencies[0].frequency;
        const minFreq =
          analysis.frequencies[analysis.frequencies.length - 1].frequency;
        const freqMap = new Map(
          analysis.frequencies.map((f) => [f.number, f.frequency]),
        );
        const maxLag = analysis.lags[0].lag;
        const minLag = analysis.lags[analysis.lags.length - 1].lag;
        const lagMap = new Map(analysis.lags.map((l) => [l.number, l.lag]));
        const markovScores = {};
        const lastDrawNumbers = [
          lastDraw.F1,
          lastDraw.F2,
          lastDraw.F3,
          lastDraw.F4,
          lastDraw.F5,
          lastDraw.F6,
        ];
        for (let i = 1; i <= 39; i++) {
          let mScore = 0;
          for (const prevNum of lastDrawNumbers) {
            if (
              analysis.markovTransitions[prevNum] &&
              analysis.markovTransitions[prevNum][i]
            ) {
              mScore += analysis.markovTransitions[prevNum][i];
            }
          }
          markovScores[i] = mScore;
        }
        const maxMarkov = Math.max(...Object.values(markovScores));
        scores.forEach((item) => {
          const freqScore =
            ((freqMap.get(item.number) || minFreq) - minFreq) /
            (maxFreq - minFreq);
          const lagScore =
            ((lagMap.get(item.number) || minLag) - minLag) / (maxLag - minLag);
          const markovScoreNorm =
            (markovScores[item.number] || 0) / (maxMarkov || 1);
          item.score = freqScore * 0.4 + lagScore * 0.3 + markovScoreNorm * 0.3;
        });
        return scores.sort((a, b) => b.score - a.score);
      }

      function displayStrategyWeights() {
        const container = document.getElementById("strategy-weights");
        if (!container) return;
        container.innerHTML = Object.entries(strategyWeights)
          .map(
            ([key, val]) =>
              `<div class="p-2 bg-gray-700 rounded-md text-center"><div class="text-xs text-gray-400">${key.replace(/_/g, " ").replace(/\b\w/g, (l) => l.toUpperCase())}</div><div class="font-bold text-lg">${val.toFixed(2)}</div></div>`,
          )
          .join("");
      }

      function displayDiagnosticsDashboard() {
        const container = document.getElementById("diagnostics-view");
        container.innerHTML = `<h2 class="text-3xl font-bold mb-6 border-b-2 border-gray-700 pb-2"><i class="fas fa-stethoscope mr-2 text-green-400"></i>Diagn贸stico del Modelo</h2><p class="text-gray-400 mb-6">Esta vista muestra la tasa de acierto hist贸rica de cada regla individual de la "Estrategia Inteligente".</p><div id="diagnostics-content" class="space-y-4"><div class="flex justify-center items-center"><i class="fas fa-spinner fa-spin fa-2x text-indigo-400"></i><p class="ml-3">Calculando rendimiento hist贸rico...</p></div></div>`;
        setTimeout(() => {
          const contentContainer = document.getElementById(
            "diagnostics-content",
          );
          if (!contentContainer) return;
          const ruleHits = Object.fromEntries(
            Object.keys(defaultWeights).map((key) => [key, 0]),
          );
          const totalDraws = fullHistory.length;
          const ruleToWeightMap = {
            "Suma en Rango": "suma_rango",
            "Distribuci贸n Par/Impar": "dist_par_impar",
            "Mix Frecuencia": "mix_frecuencia",
            "Mix Atraso": "mix_atraso",
            "Distribuci贸n Decenas": "decenas_distribucion",
            "Pares Frecuentes": "pares_frecuentes",
            "Predicci贸n Markov": "prediccion_markov",
            Consecutivos: "consecutivos",
            Terminaciones: "terminaciones",
          };
          for (const draw of fullHistory) {
            const combo = [
              draw.F1,
              draw.F2,
              draw.F3,
              draw.F4,
              draw.F5,
              draw.F6,
            ];
            const { breakdown } = rateCombination(combo);
            Object.entries(ruleToWeightMap).forEach(([ruleName, weightKey]) => {
              if (breakdown[ruleName] > 0) ruleHits[weightKey]++;
            });
          }
          const hitRates = Object.entries(ruleHits)
            .map(([key, hits]) => ({
              name: key
                .replace(/_/g, " ")
                .replace(/\b\w/g, (l) => l.toUpperCase()),
              percentage: (hits / totalDraws) * 100,
              hits: hits,
            }))
            .sort((a, b) => b.percentage - a.percentage);
          contentContainer.innerHTML = hitRates
            .map(
              (rule) =>
                `<div class="stat-card p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h4 class="text-lg font-semibold text-indigo-300">${rule.name}</h4><span class="font-bold text-xl text-white">${rule.percentage.toFixed(1)}%</span></div><div class="progress-bar"><div class="progress-bar-fill" style="width: 0%;"></div></div><p class="text-right text-xs text-gray-400 mt-1">Acierto en ${rule.hits} de ${totalDraws} sorteos</p></div>`,
            )
            .join("");
          contentContainer
            .querySelectorAll(".progress-bar-fill")
            .forEach((bar, index) => {
              setTimeout(() => {
                bar.style.width = `${hitRates[index].percentage.toFixed(1)}%`;
                bar.innerHTML = `<span class="font-semibold">${hitRates[index].percentage.toFixed(1)}%</span>`;
              }, 50 * index);
            });
        }, 50);
      }

      function displayGenerator() {
        const container = document.getElementById("generator-view");
        container.innerHTML = `<div class="stat-card p-6 rounded-lg"><h2 class="text-2xl font-bold mb-4">Generador de Combinaciones</h2><div class="flex flex-col space-y-4"><div><label for="strategy-select" class="block mb-2 font-semibold">Elige una Estrategia:</label><select id="strategy-select" class="w-full p-2 bg-gray-700 rounded-md border border-gray-600"><option value="inteligente">Estrategia Inteligente (Recomendado)</option><option value="calientes">Usar N煤meros Calientes</option><option value="frios">Usar N煤meros Fr铆os</option><option value="3_pares_3_impares">3 Pares y 3 Impares</option><option value="suma_frecuente">Suma en Rango Frecuente</option><option value="aleatorio">Completamente Aleatorio</option></select></div><div id="num-balls-control" class="hidden"><label for="num-balls-select" class="block mb-2 font-semibold">N煤meros a Jugar:</label><select id="num-balls-select" class="w-full p-2 bg-gray-700 rounded-md border border-gray-600"><option value="6">6 N煤meros (Combinaci贸n Simple)</option><option value="7">7 N煤meros</option><option value="8">8 N煤meros</option><option value="9">9 N煤meros</option><option value="10">10 N煤meros</option></select></div><div id="min-confidence-control" class="hidden"> <label for="confidence-select" class="block mb-2 font-semibold">Nivel de Confianza M铆nimo:</label> <select id="confidence-select" class="w-full p-2 bg-gray-700 rounded-md border border-gray-600"><option value="90">Muy Alta (90%+)</option> <option value="80">Alta (80%+)</option> <option value="60">Media (60%+)</option> <option value="0" selected>Cualquiera</option> </select> </div><div><label for="quantity-input" class="block mb-2 font-semibold">Cantidad de Sugerencias:</label><input id="quantity-input" type="number" value="10" min="1" max="50" class="w-full p-2 bg-gray-700 rounded-md border border-gray-600"></div><button id="btn-generate" class="w-full bg-purple-600 hover:bg-purple-700 p-3 rounded-lg text-lg font-semibold">Generar</button></div><div id="results-container" class="mt-6"></div></div>`;
        const strategySelect = document.getElementById("strategy-select"),
          numBallsControl = document.getElementById("num-balls-control"),
          confidenceControl = document.getElementById("min-confidence-control"),
          quantityInputLabel = document.querySelector(
            'label[for="quantity-input"]',
          );
        const handleStrategyChange = () => {
          if (strategySelect.value === "inteligente") {
            numBallsControl.classList.remove("hidden");
            handleNumBallsChange();
          } else {
            numBallsControl.classList.add("hidden");
            confidenceControl.classList.add("hidden");
            quantityInputLabel.textContent = "Cantidad de Combinaciones:";
          }
        };
        const handleNumBallsChange = () => {
          const numBalls = parseInt(
            document.getElementById("num-balls-select").value,
          );
          if (numBalls === 6) {
            confidenceControl.classList.remove("hidden");
            quantityInputLabel.textContent = "Cantidad de Combinaciones:";
          } else {
            confidenceControl.classList.add("hidden");
            quantityInputLabel.textContent = "Cantidad de Grupos:";
          }
        };
        document
          .getElementById("num-balls-select")
          .addEventListener("change", handleNumBallsChange);
        strategySelect.addEventListener("change", handleStrategyChange);
        handleStrategyChange();
        document
          .getElementById("btn-generate")
          .addEventListener("click", handleGeneration);
      }

      function handleGeneration() {
        const strategy = document.getElementById("strategy-select").value;
        const quantity = parseInt(
          document.getElementById("quantity-input").value,
        );
        let results;
        if (strategy === "inteligente") {
          const minConfidence = parseInt(
            document.getElementById("confidence-select").value,
          );
          const numBalls = parseInt(
            document.getElementById("num-balls-select").value,
          );
          results = generateIntelligentCombinations(
            quantity,
            minConfidence,
            numBalls,
          );
          if (results.length > 0) {
            const suggestionsToSave = results.map((r) => ({
              combinacion: JSON.stringify(r.combination),
              confidence: r.confidence,
              sorteo_sugerido_para: lastDraw ? lastDraw.sorteo + 1 : 0,
              fecha_generacion: new Date(),
            }));
            const batch = writeBatch(db);
            suggestionsToSave.forEach((sug) => {
              const newDocRef = doc(suggestionsCollectionRef);
              batch.set(newDocRef, sug);
            });
            try {
              batch
                .commit()
                .then(() =>
                  showNotification(
                    "Sugerencias inteligentes guardadas para futura revisi贸n.",
                  ),
                );
            } catch (e) {
              console.error("Error al guardar sugerencias:", e);
              showNotification("Error al guardar las sugerencias.");
            }
          }
        } else {
          results = generateSimpleCombinations(quantity, strategy);
        }
        const resultsContainer = document.getElementById("results-container");
        resultsContainer.innerHTML =
          `<h3 class="text-xl font-semibold mb-3">Combinaciones Sugeridas</h3>` +
          results
            .map(
              (res) =>
                `<div class="flex flex-col sm:flex-row items-center justify-between p-2 rounded-md mb-2 bg-gray-800"><div class="flex flex-wrap justify-center gap-2">${res.combination.map((n) => `<span class="number-ball bg-gray-600 text-white">${n}</span>`).join("")}</div><span class="text-sm text-gray-400 mt-2 sm:mt-0">${res.confidence}</span></div>`,
            )
            .join("");
      }

      function displayRater() {
        const container = document.getElementById("rater-view");
        container.innerHTML = `<div class="stat-card p-6 rounded-lg"><h2 class="text-2xl font-bold mb-4">Calificador de Combinaciones</h2><p class="text-gray-400 mb-4">Introduce 6 n煤meros para ver su calificaci贸n estad铆stica basada en las reglas actuales.</p><div class="flex flex-col space-y-4"><input id="rater-input" type="text" placeholder="Ej: 5, 12, 18, 22, 30, 39" class="w-full p-2 bg-gray-700 rounded-md border border-gray-600"><button id="btn-rate" class="w-full bg-cyan-600 hover:bg-cyan-700 p-3 rounded-lg text-lg font-semibold">Calificar Combinaci贸n</button></div><div id="rater-results" class="mt-6"></div></div>`;
        document
          .getElementById("btn-rate")
          .addEventListener("click", handleRating);
      }

      function handleRating() {
        const input = document.getElementById("rater-input").value;
        const numbers = input
          .split(",")
          .map((n) => parseInt(n.trim()))
          .filter((n) => !isNaN(n) && n >= 1 && n <= 39);
        if (numbers.length !== 6) {
          showNotification(
            "Por favor, introduce exactamente 6 n煤meros v谩lidos.",
          );
          return;
        }
        const uniqueNumbers = [...new Set(numbers)];
        if (uniqueNumbers.length !== 6) {
          showNotification("Los n煤meros deben ser 煤nicos.");
          return;
        }
        const { confidence, breakdown } = rateCombination(
          uniqueNumbers.sort((a, b) => a - b),
        );
        let breakdownHTML = Object.entries(breakdown)
          .map(
            ([rule, score]) =>
              `<div class="flex justify-between text-sm"><span class="text-gray-300">${rule}:</span><span class="font-semibold ${score > 0 ? "text-green-400" : "text-gray-500"}">+${score.toFixed(2)} pts</span></div>`,
          )
          .join("");
        const resultsContainer = document.getElementById("rater-results");
        resultsContainer.innerHTML = ` <h3 class="text-xl font-semibold mb-3">Calificaci贸n para: [${uniqueNumbers.join(", ")}]</h3> <div class="space-y-2 p-4 bg-gray-800 rounded-md"> ${breakdownHTML} <div class="border-t border-gray-600 mt-3 pt-3 flex justify-between font-bold text-lg text-indigo-400"> <span>Confianza Final:</span> <span>${confidence.toFixed(0)}%</span> </div> </div>`;
      }

      function displayVerifier() {
        const container = document.getElementById("verifier-view");
        container.innerHTML = `<div class="stat-card p-6 rounded-lg"><h2 class="text-2xl font-bold mb-4">Verificador de Hist贸rico (Backtesting)</h2><p class="text-gray-400 mb-4">Introduce de 6 a 10 n煤meros separados por comas para ver su rendimiento hist贸rico.</p><div class="flex flex-col space-y-4"><input id="verifier-input" type="text" placeholder="Ej: 5, 12, 18, 22, 30, 39" class="w-full p-2 bg-gray-700 rounded-md border border-gray-600"><button id="btn-verify" class="w-full bg-teal-600 hover:bg-teal-700 p-3 rounded-lg text-lg font-semibold">Verificar</button></div><div id="verifier-results" class="mt-6"></div></div>`;
        document
          .getElementById("btn-verify")
          .addEventListener("click", handleVerification);
      }

      function handleVerification() {
        const input = document.getElementById("verifier-input").value;
        const numbers = input
          .split(",")
          .map((n) => parseInt(n.trim()))
          .filter((n) => !isNaN(n) && n >= 1 && n <= 39);
        if (numbers.length < 6 || numbers.length > 10) {
          showNotification(
            "Por favor, introduce entre 6 y 10 n煤meros v谩lidos.",
          );
          return;
        }
        const userSet = new Set(numbers);
        const counts = { 6: 0, 5: 0, 4: 0, 3: 0, 2: 0 };
        fullHistory.forEach((draw) => {
          const drawSet = new Set([
            draw.F1,
            draw.F2,
            draw.F3,
            draw.F4,
            draw.F5,
            draw.F6,
          ]);
          const hits = new Set([...userSet].filter((x) => drawSet.has(x))).size;
          if (hits >= 2) counts[hits]++;
        });
        const resultsContainer = document.getElementById("verifier-results");
        let title =
          numbers.length === 6
            ? `Resultados para la Combinaci贸n: [${numbers.join(", ")}]`
            : `Resultados para el Grupo de ${numbers.length} n煤meros`;
        let resultText = numbers.length === 6 ? "Aciertos de" : "Sorteos con";
        resultsContainer.innerHTML = `<h3 class="text-xl font-semibold mb-3">${title}</h3>${Object.entries(
          counts,
        )
          .reverse()
          .map(
            ([hits, count]) =>
              `<div class="flex justify-between text-sm mb-1"><span>${resultText} <b>${hits}</b> n煤meros:</span><span class="font-semibold">${count} veces</span></div>`,
          )
          .join("")}`;
        const lastWinningDraw = new Set([
          fullHistory[0].F1,
          fullHistory[0].F2,
          fullHistory[0].F3,
          fullHistory[0].F4,
          fullHistory[0].F5,
          fullHistory[0].F6,
        ]);
        const lastDrawHits = numbers.filter((n) =>
          lastWinningDraw.has(n),
        ).length;
        resultsContainer.innerHTML += `<div class="mt-6 pt-4 border-t border-gray-600"><h4 class="text-lg font-semibold mb-2">Comparaci贸n con ltimo Sorteo (${fullHistory[0].sorteo})</h4><div class="flex flex-wrap justify-center gap-2 mb-2">${numbers.map((n) => `<span class="number-ball ${lastWinningDraw.has(n) ? "bg-green-500" : "bg-gray-600"} text-white">${n}</span>`).join("")}</div><p class="text-center font-bold">Tuviste ${lastDrawHits} aciertos.</p></div>`;
      }

      async function displayReviewer() {
        const container = document.getElementById("reviewer-view");
        container.innerHTML = `<div class="stat-card p-6 rounded-lg"><h2 class="text-2xl font-bold mb-4">Revisar Sugerencias Pasadas</h2><div id="reviewer-content">Cargando sugerencias...</div></div>`;
        try {
          const suggestionsSnapshot = await getDocs(
            query(
              suggestionsCollectionRef,
              orderBy("sorteo_sugerido_para", "desc"),
            ),
          );
          const suggestionsByDraw = {};
          suggestionsSnapshot.docs.forEach((doc) => {
            const data = doc.data();
            const key = data.sorteo_sugerido_para;
            if (!suggestionsByDraw[key]) suggestionsByDraw[key] = [];
            suggestionsByDraw[key].push(data);
          });
          if (Object.keys(suggestionsByDraw).length === 0) {
            document.getElementById("reviewer-content").innerHTML =
              `<p class="text-gray-400">No se encontraron sugerencias guardadas. Genera algunas con la "Estrategia Inteligente" primero.</p>`;
            return;
          }
          let optionsHTML = Object.keys(suggestionsByDraw)
            .sort((a, b) => b - a)
            .map(
              (drawNum) =>
                `<option value="${drawNum}">Sorteo ${drawNum}</option>`,
            )
            .join("");
          document.getElementById("reviewer-content").innerHTML =
            ` <div class="flex flex-col space-y-4"> <label for="review-draw-select" class="block mb-2 font-semibold">Selecciona un sorteo para revisar:</label> <select id="review-draw-select" class="w-full p-2 bg-gray-700 rounded-md border border-gray-600">${optionsHTML}</select> <div id="review-results-area" class="mt-6 space-y-4"></div> </div>`;
          const select = document.getElementById("review-draw-select");
          select.addEventListener("change", (e) =>
            handleReviewSelection(e.target.value, suggestionsByDraw),
          );
          handleReviewSelection(select.value, suggestionsByDraw);
        } catch (e) {
          console.error("Error cargando sugerencias:", e);
          document.getElementById("reviewer-content").innerHTML =
            `<p class="text-red-500">Error al cargar las sugerencias.</p>`;
        }
      }

      function handleReviewSelection(drawNumberStr, suggestionsByDraw) {
        const drawNumber = parseInt(drawNumberStr);
        const suggestions = suggestionsByDraw[drawNumber];
        const winningDraw = fullHistory.find((d) => d.sorteo === drawNumber);
        const reviewArea = document.getElementById("review-results-area");
        if (!winningDraw) {
          reviewArea.innerHTML = `<p class="text-yellow-400">A煤n no se ha cargado el resultado del sorteo ${drawNumber}.</p>`;
          return;
        }
        const winningCombo = [
          winningDraw.F1,
          winningDraw.F2,
          winningDraw.F3,
          winningDraw.F4,
          winningDraw.F5,
          winningDraw.F6,
        ].sort((a, b) => a - b);
        let html = `<h3 class="text-xl font-bold text-indigo-400">Resultado Real del Sorteo ${drawNumber}</h3><div class="flex flex-wrap justify-center sm:justify-start gap-2 my-2">${winningCombo.map((n) => `<span class="number-ball bg-green-600 text-white">${n}</span>`).join("")}</div>`;
        suggestions.forEach((sug) => {
          let suggestedCombo;
          try {
            suggestedCombo =
              typeof sug.combinacion === "string"
                ? JSON.parse(sug.combinacion)
                : Array.isArray(sug.combinacion)
                  ? sug.combinacion
                  : null;
            if (!suggestedCombo) return;
          } catch (e) {
            return;
          }
          const hits = suggestedCombo.filter((n) =>
            winningCombo.includes(n),
          ).length;
          const { breakdown: sugBreakdown } = rateCombination(suggestedCombo);
          const { breakdown: winBreakdown } = rateCombination(winningCombo);
          html += ` <div class="p-4 bg-gray-800 rounded-lg border border-gray-700"> <div class="flex flex-col sm:flex-row justify-between items-center"> <div class="flex flex-wrap justify-center gap-2">${suggestedCombo.map((n) => `<span class="number-ball ${winningCombo.includes(n) ? "bg-green-500" : "bg-gray-600"} text-white">${n}</span>`).join("")}</div> <div class="text-center sm:text-right mt-3 sm:mt-0"> <p class="text-lg font-bold">${hits} de ${suggestedCombo.length} aciertos</p> <p class="text-sm text-gray-400">${sug.confidence}</p> </div> </div> <div class="mt-4 pt-4 border-t border-gray-600 text-xs grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2"> <div> <h4 class="font-semibold mb-1 text-gray-300">An谩lisis de la Sugerencia:</h4> ${Object.entries(
            sugBreakdown,
          )
            .map(
              ([rule, score]) =>
                `<p class="${score > 0 ? "text-green-400" : "text-red-400"}">${rule}: ${score > 0 ? "锔 Acierto" : " Fallo"}</p>`,
            )
            .join(
              "",
            )} </div> <div class="mt-2 md:mt-0"> <h4 class="font-semibold mb-1 text-gray-300">An谩lisis del Ganador:</h4> ${Object.entries(
            winBreakdown,
          )
            .map(
              ([rule, score]) =>
                `<p class="${score > 0 ? "text-green-400" : "text-red-400"}">${rule}: ${score > 0 ? "锔 Acierto" : " Fallo"}</p>`,
            )
            .join("")} </div> </div> </div> `;
        });
        reviewArea.innerHTML = html;
      }

      function displayPredictions() {
        const container = document.getElementById("predictions-view");
        container.innerHTML = `<h2 class="text-2xl font-bold mb-4">Predicciones del Modelo (Markov)</h2><p class="text-gray-400 mb-6">Basado en el 煤ltimo sorteo, estos son los 5 n煤meros con mayor probabilidad de aparecer a continuaci贸n de cada n煤mero ganador.</p><div id="predictions-content" class="space-y-4"></div>`;
        let predictionsContent = "";
        const lastDrawNumbers = [
          lastDraw.F1,
          lastDraw.F2,
          lastDraw.F3,
          lastDraw.F4,
          lastDraw.F5,
          lastDraw.F6,
        ];
        lastDrawNumbers.forEach((num) => {
          predictionsContent += `<div class="flex items-center gap-4"> <span class="number-ball bg-indigo-600 text-white">${num}</span> <i class="fas fa-arrow-right text-gray-400"></i> <div class="flex flex-wrap gap-2">`;
          const transitions = analysis.markovTransitions[num];
          if (transitions) {
            const top5 = Object.entries(transitions)
              .sort(([, a], [, b]) => b - a)
              .slice(0, 5);
            predictionsContent += top5
              .map(
                ([nextNum, count]) =>
                  `<span class="number-ball bg-gray-600 text-white">${nextNum}</span>`,
              )
              .join("");
          } else {
            predictionsContent += `<span class="text-sm text-gray-500">Sin datos de transici贸n</span>`;
          }
          predictionsContent += `</div></div>`;
        });
        document.getElementById("predictions-content").innerHTML =
          predictionsContent;
      }

      async function displayTopGlobal() {
        const container = document.getElementById("top-global-view");
        container.innerHTML = `<h2 class="text-2xl font-bold mb-4">Top 100 Global (Fuerza Bruta)</h2><p class="text-gray-400 mb-6">Estas son las mejores combinaciones encontradas despu茅s de analizar los 3.2 millones de posibilidades. Para actualizar esta lista, ejecuta el script de Python localmente.</p><div id="top-global-results" class="space-y-2">Cargando ranking...</div>`;
        const resultsContainer = document.getElementById("top-global-results");
        try {
          const querySnapshot = await getDocs(
            query(
              bruteForceResultsCollectionRef,
              orderBy("confidence", "desc"),
              limit(100),
            ),
          );
          if (querySnapshot.empty) {
            resultsContainer.innerHTML = `<p class="text-yellow-400 text-center">No se encontraron resultados de fuerza bruta. Por favor, ejecuta el script de Python localmente para generar el ranking.</p>`;
            return;
          }
          const topResults = querySnapshot.docs.map((doc) => doc.data());
          resultsContainer.innerHTML = topResults
            .map((res) => {
              let combination;
              try {
                combination = JSON.parse(res.combination);
              } catch (e) {
                combination = [];
              }
              return `<div class="flex flex-col sm:flex-row items-center justify-between p-2 rounded-md mb-2 bg-gray-800"><div class="flex flex-wrap justify-center gap-2">${combination.map((n) => `<span class="number-ball bg-gray-600 text-white">${n}</span>`).join("")}</div><span class="text-sm text-yellow-400 font-bold mt-2 sm:mt-0">Confianza: ${res.confidence.toFixed(2)}%</span></div>`;
            })
            .join("");
        } catch (error) {
          console.error("Error al cargar Top Global:", error);
          resultsContainer.innerHTML = `<p class="text-red-500 text-center">Error al cargar el ranking. Revisa la consola.</p>`;
        }
      }

      function showNotification(message) {
        document.getElementById("notification-message").innerText = message;
        document
          .getElementById("notification-modal")
          .classList.remove("hidden");
      }

      function showConfirmation(message, onConfirm) {
        const modal = document.getElementById("confirmation-modal"),
          messageEl = document.getElementById("confirmation-message"),
          confirmBtn = document.getElementById("btn-confirm-action"),
          cancelBtn = document.getElementById("btn-cancel-action");
        messageEl.textContent = message;
        const confirmHandler = () => {
          onConfirm();
          modal.classList.add("hidden");
          confirmBtn.removeEventListener("click", confirmHandler);
          cancelBtn.removeEventListener("click", cancelHandler);
        };
        const cancelHandler = () => {
          modal.classList.add("hidden");
          confirmBtn.removeEventListener("click", confirmHandler);
          cancelBtn.removeEventListener("click", cancelHandler);
        };
        confirmBtn.addEventListener("click", confirmHandler);
        cancelBtn.addEventListener("click", cancelHandler);
        modal.classList.remove("hidden");
      }

      function showRecalculateConfirmation() {
        showConfirmation(
          "驴Est谩s seguro? Esto recalcular谩 los pesos de la estrategia bas谩ndose en el historial completo. El aprendizaje manual se perder谩.",
          calculateAndSetIdealWeights,
        );
      }

      async function calculateAndSetIdealWeights() {
        if (fullHistory.length < 10) {
          showNotification(
            "Se necesitan al menos 10 sorteos en el hist贸rico para calcular pesos fiables.",
          );
          return;
        }
        showNotification("Calculando pesos ideales basados en el hist贸rico...");
        const totalDraws = fullHistory.length;
        const ruleHits = Object.fromEntries(
          Object.keys(defaultWeights).map((key) => [key, 0]),
        );
        const ruleToWeightMap = {
          "Suma en Rango": "suma_rango",
          "Distribuci贸n Par/Impar": "dist_par_impar",
          "Mix Frecuencia": "mix_frecuencia",
          "Mix Atraso": "mix_atraso",
          "Distribuci贸n Decenas": "decenas_distribucion",
          "Pares Frecuentes": "pares_frecuentes",
          "Predicci贸n Markov": "prediccion_markov",
          Consecutivos: "consecutivos",
          Terminaciones: "terminaciones",
        };
        for (const draw of fullHistory) {
          const combo = [
            draw.F1,
            draw.F2,
            draw.F3,
            draw.F4,
            draw.F5,
            draw.F6,
          ].sort((a, b) => a - b);
          const { breakdown } = rateCombination(combo);
          Object.entries(ruleToWeightMap).forEach(([ruleName, weightKey]) => {
            if (breakdown[ruleName] > 0) ruleHits[weightKey]++;
          });
        }
        const hitRates = {};
        Object.keys(ruleHits).forEach((key) => {
          hitRates[key] = ruleHits[key] / totalDraws;
        });
        const totalRate = Object.values(hitRates).reduce(
          (sum, rate) => sum + rate,
          0,
        );
        const idealWeights = {};
        Object.keys(hitRates).forEach((key) => {
          idealWeights[key] = (hitRates[key] / totalRate) * 100;
        });
        try {
          await setDoc(configDocRef, idealWeights);
          strategyWeights = { ...idealWeights };
          showNotification("隆Pesos ideales calculados y guardados con 茅xito!");
          switchView("stats-dashboard");
        } catch (e) {
          console.error("Error al guardar pesos ideales:", e);
          showNotification("No se pudieron guardar los nuevos pesos.");
        }
      }

      // --- HELPER FUNCTIONS ---
      function combinations(arr, k) {
        let result = [];
        function backtrack(start, currentCombo) {
          if (currentCombo.length === k) {
            result.push([...currentCombo]);
            return;
          }
          for (let i = start; i < arr.length; i++) {
            currentCombo.push(arr[i]);
            backtrack(i + 1, currentCombo);
            currentCombo.pop();
          }
        }
        backtrack(0, []);
        return result;
      }
      function percentile(arr, p) {
        if (arr.length === 0) return 0;
        const sorted = [...arr].sort((a, b) => a - b);
        const pos = (sorted.length - 1) * (p / 100);
        const base = Math.floor(pos);
        const rest = pos - base;
        if (sorted[base + 1] !== undefined) {
          return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
        } else {
          return sorted[base];
        }
      }
      function sample(arr, k) {
        const shuffled = [...arr].sort(() => 0.5 - Math.random());
        return new Set(shuffled.slice(0, k));
      }
      function sum(arr) {
        return arr.reduce((a, b) => a + b, 0);
      }
    </script>
  </body>
</html>
